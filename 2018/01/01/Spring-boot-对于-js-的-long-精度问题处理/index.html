<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="KIWI,kiwiflydream@gmail.com"><title>Spring boot 对于 js 的 long 精度问题处理 · 求索之路</title><meta name="description" content="这几天前后端联调，遇到一个诡异的问题。前端请求后端提供的详情接口得到用户的 Id 与其它数据。然后前端又把这个 Id与修改的数据内容一同传回后端的修改接口。结果前端反馈死活修改不了。  
然后各种 debug 查日志，发现详情接口返回给前端的与前端调用修改接口传回的 Id 不一致。  
然后一查发现"><meta name="keywords" content="Hexo,HTML,CSS,java,Linux,code,spring"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><link rel="stylesheet" href="/css/prism-xonokai.css" type="text/css"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">求索之路</a></h3><div class="description"><p>路漫漫其修远兮，吾将上下而求索</p></div></div></div><ul class="social-links"><li><a href="http://weibo.com/1761079264"><i class="fa fa-weibo"></i></a></li><li><a href="http://github.com/kiwiflydream"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="https://avatars2.githubusercontent.com/u/13311001"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Spring boot 对于 js 的 long 精度问题处理</a></h3></div><div class="post-content"><p>这几天前后端联调，遇到一个诡异的问题。前端请求后端提供的详情接口得到用户的 Id 与其它数据。然后前端又把这个 Id与修改的数据内容一同传回后端的修改接口。结果前端反馈死活修改不了。  </p>
<p>然后各种 debug 查日志，发现详情接口返回给前端的与前端调用修改接口传回的 Id 不一致。  </p>
<p>然后一查发现是 js 的精度问题，原以为 js 只是浮点型会有精度问题，没想到长整型也会出现。因为是语言的限制，前端要解决这个问题，还是很吃力的。所以只能在后端在传 json 的时候把 long 全部转成 string 类型。  </p>
<p>然后问题又来了，因为项目已写了差不多了。太多地方用了 long 类型，改基础类的字段类型是不可能了。于是想在对象转 json 的时候能否统一处理。  </p>
<p>因为使用的是 spring boot 框架，而 spring boot 默认的 json 框架的Jackson。就是找了一下，果然 jackson 有一个可以自定义的类型转换器机制。直接上代码↓  </p>
<ul>
<li><p>json 转换器<br>JsonLong2StrConverter</p>
<pre><code>public class JsonLong2StrConverter extends StdSerializer&lt;Long&gt; {

  public JsonLong2StrConverter() {
    super(Long.class);
  }

  @Override
  public void serialize(Long value, JsonGenerator gen, SerializerProvider provider)
      throws IOException {

    gen.writeString(value.toString());
  }
}
</code></pre></li>
<li><p>使用配置<br>JsonConf</p>
<pre><code>@Configuration
@EnableWebMvc
public class JsonConf extends WebMvcConfigurerAdapter {

  @Override
  public void configureMessageConverters(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters) {
    converters.add(new MappingJackson2HttpMessageConverter(
        new Jackson2ObjectMapperBuilder()
//            .propertyNamingStrategy(PropertyNamingStrategy.SNAKE_CASE)
            .serializationInclusion(
                Include.NON_NULL)
            .serializerByType(Long.class, new JsonLong2StrConverter())
            .serializerByType(Long.TYPE, new JsonLong2StrConverter()).build()));
  }

}
</code></pre></li>
</ul>
<p>这样 spring boot 在转换 json 时，发现是 Long 类型就直接转成 String 类型，也就是加个单引号。</p>
<p>参考：<br><a href="http://okeeper.leanote.com/post/Spring-boot-%E9%85%8D%E7%BD%AE%E8%87%AA%E5%AE%9A%E4%B9%89Json%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2" target="_blank" rel="external">Spring boot 配置自定义Json类型转换</a></p>
<p>本文地址 <a href="https://blog.coder4j.cn/2018/01/01/Spring-boot-对于-js-的-long-精度问题处理/">https://blog.coder4j.cn/2018/01/01/Spring-boot-对于-js-的-long-精度问题处理/</a> </p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-01-01</span><i class="fa fa-tag"></i><a class="tag" href="/categories/spring-boot/" title="spring boot">spring boot </a><a class="tag" href="/categories/spring-boot/json/" title="json">json </a><a class="tag" href="/tags/spring-boot/" title="spring boot">spring boot </a><a class="tag" href="/tags/json/" title="json">json </a><a class="tag" href="/tags/精度/" title="精度">精度 </a><a class="tag" href="/tags/js/" title="js">js </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,https://blog.coder4j.cn/2018/01/01/Spring-boot-对于-js-的-long-精度问题处理/,求索之路,Spring boot 对于 js 的 long 精度问题处理,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2018/01/01/2018年新年愿景/" title="2018年新年愿景">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2017/03/18/CDN原理/" title="CDN原理">下一篇</a></li></ul></div><a id="comments"></a><div id="vcomments" style="margin:0 30px;"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/gh/xcss/valine@v1.1.7/dist/Valine.min.js?v=undefined"></script><script>var valine = new Valine({
  el:'#vcomments',
  notify:false || false, 
  verify:false|| false, 
  app_id:'8yC4X3BzOzeAMrSi2SrEwbMc-gzGzoHsz',
  app_key:'M6soikk87YmsFLtgwu6vVqed',
  placeholder:'ヾﾉ≧∀≦)o来啊，快活啊!',
  path: window.location.pathname,
  avatar:'wavatar'
})</script></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>